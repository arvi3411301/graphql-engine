version: 2
jobs:
  server:
    docker:
      - image: busybox
    steps:
      - run: echo doing nothing for server job
  console:
    docker:
      - image: busybox
    steps:
      - run: echo doing nothing for console job
  update_console:
    docker:
      - image: busybox
    steps:
      - run: echo doing nothing for update_console job
  send_pr:
    docker:
      - image: busybox
    steps:
      - run: echo doing nothing for send_pr job
  github_release:
    docker:
      - image: busybox
    steps:
      - run: echo doing nothing for github_release job
  cli:
    docker:
    - image: hasura/graphql-engine-cli-builder:v0.1
    working_directory: /go/src/github.com/hasura/graphql-engine
    steps:
    - checkout
    - restore_cache:
        keys:
        - cli-vendor-{{ checksum "cli/Gopkg.toml" }}-{{ checksum "cli/Gopkg.lock" }}
        - cli-vendor-
    - run:
        name: get cli dependencies
        working_directory: /go/src/github.com/hasura/graphql-engine/cli
        command: make deps
    - save_cache:
        key: cli-vendor-{{ checksum "cli/Gopkg.toml" }}-{{ checksum "cli/Gopkg.lock" }}
        paths:
        - cli/vendor
    # - run:
    #     name: test cli
    #     command: .circleci/cli-test.sh
    - run:
        name: build cli
        working_directory: /go/src/github.com/hasura/graphql-engine/cli
        command: |
          make build
          make compress
    - store_artifacts:
        path: cli/_output
        destination: cli 
workflows:
  version: 2
  build_and_maybe_release:
    jobs:
      - server: &filter_all_branches_all_tags
          filters:
            tags:
              only:  /.*/
      - cli:
          << : *filter_all_branches_all_tags
          requires:
            - server
      - console:
          << : *filter_all_branches_all_tags
          requires:
            - cli
      - github_release:
          filters: &only_vtags_ignore_branches
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
          requires:
            - console
      - send_pr:
          filters: *only_vtags_ignore_branches
          requires:
            - github_release
  update_release:
    jobs:
      - update_console:
          filters:
            branches:
              only: /^release-v.*/
